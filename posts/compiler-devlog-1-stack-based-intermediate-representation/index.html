<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Prologue So I started writing a compiler around a year ago, worked on it for about a month or two and then lost interest as with most of my side-projects&amp;hellip; tsc tsc.
Let&amp;rsquo;s be honest, there&amp;rsquo;s very little reason to write a compiler nowadays, if any. Hardware has gotten so powerful and software has gone so complex that we should all just use what&amp;rsquo;s already there. I feel like a Baby-Boomer born inside a Millenial body, because I miss the &amp;ldquo;good old days&amp;rdquo; (when I wasn&amp;rsquo;t even conceived yet)." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://glhrmfrts.github.io/posts/compiler-devlog-1-stack-based-intermediate-representation/" />


    <title>
        
            Compiler Devlog #1 - Stack-based Intermediate Representation (IR) :: Guilherme Nemeth 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.d7bdd8ee18bfbf4c605488a7e5b1b92cd980dfeed2bdaeab4dd5e931a7a78bc0.css">






<meta itemprop="name" content="Compiler Devlog #1 - Stack-based Intermediate Representation (IR)">
<meta itemprop="description" content="Prologue So I started writing a compiler around a year ago, worked on it for about a month or two and then lost interest as with most of my side-projects&hellip; tsc tsc.
Let&rsquo;s be honest, there&rsquo;s very little reason to write a compiler nowadays, if any. Hardware has gotten so powerful and software has gone so complex that we should all just use what&rsquo;s already there. I feel like a Baby-Boomer born inside a Millenial body, because I miss the &ldquo;good old days&rdquo; (when I wasn&rsquo;t even conceived yet).">
<meta itemprop="datePublished" content="2022-04-28T00:30:45-03:00" />
<meta itemprop="dateModified" content="2022-04-28T00:30:45-03:00" />
<meta itemprop="wordCount" content="3100">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compiler Devlog #1 - Stack-based Intermediate Representation (IR)"/>
<meta name="twitter:description" content="Prologue So I started writing a compiler around a year ago, worked on it for about a month or two and then lost interest as with most of my side-projects&hellip; tsc tsc.
Let&rsquo;s be honest, there&rsquo;s very little reason to write a compiler nowadays, if any. Hardware has gotten so powerful and software has gone so complex that we should all just use what&rsquo;s already there. I feel like a Baby-Boomer born inside a Millenial body, because I miss the &ldquo;good old days&rdquo; (when I wasn&rsquo;t even conceived yet)."/>








    <meta property="article:published_time" content="2022-04-28 00:30:45 -0300 -03" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">gnemeth</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/page/programming/">Programming</a></li><li><a href="/page/quake/">Quake</a></li><li><a href="/page/music/">Music</a></li><li><a href="/posts/">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        15 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://glhrmfrts.github.io/posts/compiler-devlog-1-stack-based-intermediate-representation/">Compiler Devlog #1 - Stack-based Intermediate Representation (IR)</a>
      </h1>

      

      

      <div class="post-content">
        <h2 id="prologue">Prologue</h2>
<p>So I started writing a compiler around a year ago, worked on it for about a month or two and then lost interest as with most of my side-projects&hellip; <em>tsc tsc</em>.</p>
<p>Let&rsquo;s be honest, there&rsquo;s very little reason to write a compiler nowadays, if any. Hardware has gotten so powerful and software has gone so complex that we should all just use what&rsquo;s already there. I feel like a Baby-Boomer born inside a Millenial body, because I miss the &ldquo;good old days&rdquo; (when I wasn&rsquo;t even conceived yet). To be fair, I remember my dad having a 386 and also him trying to teach me BASIC when I was 6 or 7 years old, I remember being excited about it but of course my kid brain wanted to just play games and have fun.</p>
<p>The point is, looking back at it, the software development landscape looked much simpler and it felt like a <em>single person or a really small team</em> could really do something innovative and disruptive, e.g. id Software creating state of the art FPS game engines, Linus Torvalds with linux, and so on. Of course that is still perfectly possible, just at a much higher level. I&rsquo;m not going to google it right now but I&rsquo;m pretty sure both Bitcoin and Ethereum were created mostly by a single individual. This web3 stuff really seems where most of the innovations are going to happen, I&rsquo;m just&hellip; not really into it.</p>
<p>Anyway, I digress, but my passion is in learning how the hardware that I&rsquo;m in contact with every day does stuff. How does a computer like&hellip; execute applications? What it&rsquo;s actually doing it? Who&rsquo;s controlling all that stuff? Oh, the CPU, okay&hellip; How does it know what to execute? How can I type 2+2 in my keyboard, see it in my screen, and actually get 4 back? You get the point, I want to understand what the CPU understands, so around a year ago I decided to learn Assembly, since my daily computer is a Windows machine with a x86_64 architecture, I decided to start with that.</p>
<p>Unfortunately I don&rsquo;t have the habit of reading books aside from fiction. I&rsquo;m easily bothered doing exercises from books to try and learn stuff. I prefer to try and do something until it works, if it doesn&rsquo;t works, there&rsquo;s always the Internet&hellip; Oh yes the Internet üòÅ. Also tinkering with stuff yourself is way more exciting and since it&rsquo;s not an actual job you are free to experiment different ways of thinking, so I decided to try and create an actual compiler to learn Assembly and what my code actually get&rsquo;s transformed when it&rsquo;s running in the CPU.</p>
<h2 id="the-programming-language">The Programming Language</h2>
<p>Having previously written some toy interpreters and virtual machines, I wasn&rsquo;t threading in completely new waters. After these toy projects, it&rsquo;s pretty much ingrained in my mind how to write a <a href="https://en.wikipedia.org/wiki/Recursive_descent_parser">Recursive Descent Parser</a>, so I decided to start with that. I decided to &ldquo;create&rdquo; a new programming language instead of writing it for an existing one, because we all have our favourite features from a number of languages that we think would be nice together.</p>
<p>I&rsquo;m not going to spend too much time in this section for now, but just to give an idea of the programming language itself, here&rsquo;s the <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Game Of Life</a> written in it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> <span style="color:#a6e22e">std</span>::<span style="color:#a6e22e">system</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">system</span>
<span style="color:#f92672">import</span> <span style="color:#a6e22e">test</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">t</span>
<span style="color:#f92672">import</span> <span style="color:#66d9ef">string</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Field2D</span> = <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">data</span>:    <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">int</span> <span style="color:#75715e">// Pointer to int
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">width</span>:   <span style="color:#66d9ef">int</span>
    <span style="color:#a6e22e">height</span>:  <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Automaton</span> = <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">field</span>:      <span style="color:#a6e22e">Field2D</span>
    <span style="color:#a6e22e">new_field</span>:  <span style="color:#a6e22e">Field2D</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makeField</span>(<span style="color:#a6e22e">sx</span>: <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">sy</span>: <span style="color:#66d9ef">int</span>): <span style="color:#a6e22e">Field2D</span> {  
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">system</span>::<span style="color:#a6e22e">alloc</span>(
        <span style="color:#a6e22e">sizeof</span>(<span style="color:#66d9ef">int</span>)<span style="color:#f92672">*</span>(<span style="color:#a6e22e">cast</span>(<span style="color:#a6e22e">usize</span>)<span style="color:#a6e22e">sx</span>)<span style="color:#f92672">*</span>(<span style="color:#a6e22e">cast</span>(<span style="color:#a6e22e">usize</span>)<span style="color:#a6e22e">sy</span>)
    )
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Field2D</span>{ <span style="color:#a6e22e">cast</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">sx</span>, <span style="color:#a6e22e">sy</span> }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">f</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Field2D</span>, <span style="color:#a6e22e">x</span>: <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">y</span>: <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">val</span>: <span style="color:#66d9ef">int</span>) {
    <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">y</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">x</span>] = <span style="color:#a6e22e">val</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">f</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pure</span> <span style="color:#a6e22e">Field2D</span>, <span style="color:#a6e22e">x</span>: <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">y</span>: <span style="color:#66d9ef">int</span>): <span style="color:#66d9ef">int</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">y</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">x</span>]
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">clear</span>(<span style="color:#a6e22e">f</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Field2D</span>) {
    <span style="color:#a6e22e">memset</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">data</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">width</span><span style="color:#f92672">*</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">height</span><span style="color:#f92672">*</span><span style="color:#a6e22e">sizeof</span>(<span style="color:#66d9ef">int</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makeAutomaton</span>(<span style="color:#a6e22e">ftext</span>: []<span style="color:#a6e22e">pure</span> <span style="color:#66d9ef">uint8</span>): <span style="color:#a6e22e">Automaton</span> {
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">f</span> = <span style="color:#a6e22e">split</span>(<span style="color:#a6e22e">ftext</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">free</span>(<span style="color:#a6e22e">f</span>)

    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">height</span> = <span style="color:#a6e22e">cast</span>(<span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">len</span>
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">width</span>  = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">y</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">len</span>) {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">width</span> &lt; <span style="color:#a6e22e">f</span>[<span style="color:#a6e22e">y</span>].<span style="color:#a6e22e">len</span>) {
            <span style="color:#a6e22e">width</span> = <span style="color:#a6e22e">cast</span>(<span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">f</span>[<span style="color:#a6e22e">y</span>].<span style="color:#a6e22e">len</span>
        }
    }

    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">field</span>    = <span style="color:#a6e22e">makeField</span>(<span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">height</span>)
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">newfield</span> = <span style="color:#a6e22e">makeField</span>(<span style="color:#a6e22e">width</span>, <span style="color:#a6e22e">height</span>)

    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">y</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">height</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">width</span>) {
            <span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, (
                (<span style="color:#a6e22e">x</span> &lt; <span style="color:#a6e22e">f</span>[<span style="color:#a6e22e">y</span>].<span style="color:#a6e22e">len</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">f</span>[<span style="color:#a6e22e">y</span>][<span style="color:#a6e22e">x</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;#&#39;</span>) <span style="color:#a6e22e">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
            ))
        }
    }

    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">a</span> = <span style="color:#a6e22e">Automaton</span>{}
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span> = <span style="color:#a6e22e">field</span>
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">new_field</span> = <span style="color:#a6e22e">newfield</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">a</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Automaton</span>) {
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">new_field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">clear</span>()
    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">y</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) {
            <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">moore_sum</span> = (
                <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
                <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span>)
                <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
                <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">y</span>)
            )
            <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">cell</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
            <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">alive</span> = (<span style="color:#a6e22e">cell</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
                        <span style="color:#a6e22e">then</span> (<span style="color:#a6e22e">moore_sum</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">moore_sum</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>)
                        <span style="color:#66d9ef">else</span> (<span style="color:#a6e22e">moore_sum</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>)
            <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">new_field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">alive</span> <span style="color:#a6e22e">then</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
        }
    }
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">tmp</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">new_field</span>
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">new_field</span> = <span style="color:#a6e22e">tmp</span>
}

<span style="color:#66d9ef">func</span> print(<span style="color:#a6e22e">a</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Automaton</span>) {
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">system</span>::<span style="color:#a6e22e">alloc</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">256</span>)
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>) { <span style="color:#a6e22e">system</span>::<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>) }
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">system</span>::<span style="color:#a6e22e">free</span>(<span style="color:#a6e22e">buf</span>)

    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">y</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">height</span>) {
        <span style="color:#a6e22e">memset</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">256</span>)
        <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">s</span> = []<span style="color:#66d9ef">uint8</span>{ (<span style="color:#a6e22e">cast</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">uint8</span>)<span style="color:#a6e22e">buf</span>), <span style="color:#ae81ff">0</span> }

        <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">width</span>) {
            <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">cell</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">field</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">x</span>,<span style="color:#a6e22e">y</span>)
            <span style="color:#a6e22e">s</span>[<span style="color:#a6e22e">x</span>] = <span style="color:#a6e22e">cell</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">then</span> <span style="color:#e6db74">&#39;@&#39;</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;.&#39;</span>
            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">len</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        }
        println(<span style="color:#a6e22e">s</span>)
    }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makeGun</span>(): <span style="color:#a6e22e">Automaton</span> {
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">gunfield</span> = <span style="color:#e6db74">&#34;*******************************************
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                     #    #              *
</span><span style="color:#e6db74">*  ##                 #    #              *
</span><span style="color:#e6db74">*  ##                 #    #              *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*                                         *
</span><span style="color:#e6db74">*******************************************&#34;</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">makeAutomaton</span>(<span style="color:#a6e22e">gunfield</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">gameOfLife</span>() {
    <span style="color:#a6e22e">let</span> <span style="color:#a6e22e">a</span> = <span style="color:#a6e22e">makeGun</span>()
    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">i</span> <span style="color:#a6e22e">in</span> <span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">150</span>) {
        <span style="color:#a6e22e">a</span><span style="color:#f92672">-</span>&gt;<span style="color:#a6e22e">update</span>()
        <span style="color:#a6e22e">a</span><span style="color:#f92672">-</span>&gt;print()
        <span style="color:#a6e22e">system</span>::<span style="color:#a6e22e">sleepMs</span>(<span style="color:#ae81ff">200</span>)
    }
}
</code></pre></div><p>There&rsquo;s a handful of things that still are temporary or not really well-designed, but if I give you the compiler now, you could compile it and run it. At the moment, both Windows and Linux x64 are supported, the most important thing missing right now is floating-point arithmetic, but that will come very soon, or maybe not. üò≥</p>
<h2 id="architecture">Architecture</h2>
<p>Again, in a possible future Devlog I may give a better overview of the overall architecture and design, but the truth is it&rsquo;s all a mess right now üòÖ.</p>
<p>I started very simple:</p>
<p><strong>Lexer (Tokens) -&gt; Parser (AST) -&gt; Type Checker -&gt; x64 ASM Generator</strong></p>
<p>However this didn&rsquo;t work out at all, the generated Assembly had expressions stepping in each other&rsquo;s registers all the time and some complex expressions I simply had no idea how to transform into valid Assembly code.</p>
<p>In my research I learned that most compilers have some sort of <a href="https://en.wikipedia.org/wiki/Intermediate_representation">IR (Intermediate Representation)</a>, so after some consideration I decided I needed an IR to be a middle-point between the high-level AST and the low-level Assembly code, so the architecture looks like this right now:</p>
<p><strong>Lexer (Tokens) -&gt; Parser (AST) -&gt; Type Checker -&gt; Desugar -&gt; IR -&gt; x64 ASM</strong></p>
<h2 id="the-ir">The IR</h2>
<p>Finally we are at the main subject of this post. üôÉ</p>
<p>Much like the Parser, I am also pretty familiar with <a href="https://en.wikipedia.org/wiki/Stack_machine">Stack machines</a>, having written at least a couple of them. The idea is very simple: you push values to the stack, and pop it when you need to perform operations on them.</p>
<p>So the expression:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">print(<span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>)
</code></pre></div><p>Could be performed as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">PUSH <span style="color:#ae81ff">2</span>
PUSH <span style="color:#ae81ff">5</span>
ADD <span style="color:#75715e">// operates on the top 2 operands on the stack and push the result
</span><span style="color:#75715e"></span>CALL print <span style="color:#ae81ff">1</span> <span style="color:#75715e">// pop 1 operand from the stack to use as the argument
</span></code></pre></div><p>This is pretty similar to some Bytecodes from some interpreted programming languages, it&rsquo;s simple and gets the job done.</p>
<p>At the time when I created this IR, I did not know about <a href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA</a> or <a href="https://en.wikipedia.org/wiki/Three-address_code">Three-address code</a>. Looking back at it now, I feel like I should have done it like that, but what is done is done and I&rsquo;m not going to refactor all the IR and Codegen right now LOL.</p>
<p>Anyway, my IR is kind of a hybrid between Stack machine and Three-address code. Here&rsquo;s the IR for the <em>clear</em> function of the Game of Life example above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">func gameoflife<span style="color:#f92672">::</span>clear <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">void</span>
    arg <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span> f: <span style="color:#f92672">&amp;</span>Field2D;
    ir_deref <span style="color:#a6e22e">ARG</span>(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_stack_dup; <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_stack_dup; <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_mul [POP() . <span style="color:#ae81ff">1</span>] [POP() . <span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_mul <span style="color:#a6e22e">POP</span>() <span style="color:#ae81ff">4</span>; <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_cast <span style="color:#a6e22e">POP</span>(); <span style="color:#75715e">// (push)
</span><span style="color:#75715e"></span>    ir_call memset [POP() . <span style="color:#ae81ff">0</span>] <span style="color:#ae81ff">0</span> POP();
endf
</code></pre></div><p>As you can see, there&rsquo;s a stack that operands are being pushed to, but there&rsquo;s also direct operands, and in fact one of the operands (<em>POP()</em>) is a placeholder that says &ldquo;Please pop from the stack to get this operand&rdquo;.</p>
<p>Again, this might not be the correct way to do it, especially because some of the most well-known optimizations that are done to Three-address code and SSA are not applicable here, but I think if someone wants to seriously use this compiler, they need professional help, or at least to write a C back-end for it. ü§£</p>
<p>The cool thing about it though, is that I don&rsquo;t need to worry about Register Allocation here, I just push things to an imaginary stack and someone else will have to implement this imaginary stack, in this case it&rsquo;s myself, but at least I know that a stack WORKS, I just need to emulate it using the x64 assembly code.</p>
<h2 id="ir-to-assembly">IR to Assembly</h2>
<p>First, here&rsquo;s the Assembly (Intel syntax) generated from the IR above (without name mangling for clarity):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">clear:
    <span style="color:#75715e">;func clear(&amp;Field2D): {}</span>
    mov qword[rsp+8],rcx
    push rbp
    push rbx
    push r12
    mov rbp,rsp
    sub rsp,32
    <span style="color:#75715e">;prolog end</span>

    mov rbx,qword[rbp+32]
    <span style="color:#75715e">;ir_deref A0; (push)</span>

    <span style="color:#75715e">;ir_stack_dup; (push)</span>

    <span style="color:#75715e">;ir_stack_dup; (push)</span>

    mov r10d,dword[rbx+8]
    imul r10d,dword[rbx+12]
    mov eax,r10d
    <span style="color:#75715e">;ir_mul [POP() . 1] [POP() . 2]; (push)</span>

    imul eax,4
    <span style="color:#75715e">;ir_mul POP() 4; (push)</span>

    movsxd rax,eax
    <span style="color:#75715e">;ir_cast POP(); (push)</span>

    mov r8,rax
    xor dl,dl
    mov rcx,qword[rbx+0]
    call memset
    <span style="color:#75715e">;ir_call memset [POP() . 0] 0 POP();</span>

clear$end:
    add rsp,32
    pop r12
    pop rbx
    pop rbp
    ret
</code></pre></div><p>The original IR instructions are commented right after the generated Assembly so you can see which IR instruction generated which parts of the code. Let&rsquo;s walk through this piece py piece:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    <span style="color:#75715e">;func clear(&amp;Field2D): {}</span>
    mov qword[rsp+8],rcx
    push rbp
    push rbx
    push r12
    mov rbp,rsp
    sub rsp,32
    <span style="color:#75715e">;prolog end</span>
</code></pre></div><p>This is the <em>function prologue</em>, a common piece of code that is similar in the beginning of all functions, it transfer the function arguments to memory (sometimes), saves any callee-saved registers used by the function, and allocates space for it&rsquo;s stack frame (local variables). In fact, I just found a bug here, the <em>r12</em> register should not be pushed here üòÖ. But the concept is the same regardless.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov rbx,qword[rbp+32]
    <span style="color:#75715e">;ir_deref A0; (push)</span>
</code></pre></div><p>This bit here is implementing a <em>pointer dereferencing</em>, it&rsquo;s taking the 1st argument of the function (which is a pointer to the <strong>Field2D</strong> struct) and moving the address contained there to the <em>rbx</em> register.</p>
<p>As you can see, this IR instructions pushes to the imaginary stack I was talking about, so let&rsquo;s go in more detail about that.</p>
<p>First let&rsquo;s visualize a stack:</p>
<pre><code>| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>This is a stack of one element (the number 0), so we say that 0 is at the top of the stack, let&rsquo;s push one more element, the number 1:</p>
<pre><code>| ------------------ |
|                    |
|         1          |
|                    |
| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>And the number 2:</p>
<pre><code>| ------------------ |
|                    |
|         2          |
|                    |
| ------------------ |
|                    |
|         1          |
|                    |
| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>Now the number 2 is at the top of the stack, great, let&rsquo;s pop 2 elements from it:</p>
<pre><code>                                                 | ------------------ |
                                                 |                    |
                      Bye bye number 2:          |         2          |
                                                 |                    |
                                                 | ------------------ |
| ------------------ |
|                    |
|         1          |
|                    |
| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>The stack is like this now:</p>
<pre><code>| ------------------ |
|                    |
|         1          |
|                    |
| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>Let&rsquo;s pop one more element:</p>
<pre><code>                                                 | ------------------ |
                                                 |                    |
                      Bye bye number 1:          |         1          |
                                                 |                    |
                                                 | ------------------ |
| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><p>And the stack is back to just the number 0:</p>
<pre><code>| ------------------ |
|                    |
|         0          |
|                    |
| ------------------ |
</code></pre><hr>
<p><em>(OK this is basic CS knowledge but I love to visualize stuff in articles so bear with me)</em></p>
<hr>
<p>Anyway, going back to the imaginary IR stack, there&rsquo;s a number of registers that I classified as eligible to be used by the stack, I called them the <em>IR stack registers</em>, they change from platform to platform, but when compiling for Windows they are:</p>
<p><em>rbx</em>, <em>r12</em>, <em>r13</em>, <em>r14</em>, <em>r15</em></p>
<p>Also, <em>rax</em> is always pushed to the IR stack if the next instruction consumes at least one operand from the stack, because it is a volatile register, unlike the others above.</p>
<p>So, remember this ASM code?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov rbx,qword[rbp+32]
    <span style="color:#75715e">;ir_deref A0; (push)</span>
</code></pre></div><p>When we are moving to <em>rbx</em> we are actually pushing a value to the <em>IR stack</em>. So the stack looks like this now:</p>
<pre><code>| ------------------ |
|                    |
|         rbx        |
|                    |
| ------------------ |
</code></pre><p>Okay, let&rsquo;s look at the next instruction:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    <span style="color:#75715e">;ir_stack_dup; (push)</span>

    <span style="color:#75715e">;ir_stack_dup; (push)</span>
</code></pre></div><p>As you can see, these two instructions didn&rsquo;t generate any assembly code, but they manipulate the internal <em>IR stack</em> at compile-time, <em>ir_stack_dup</em> will duplicate the value at the top of the stack, pushing it again. So the stack now is:</p>
<pre><code>| ------------------ |
|                    |
|         rbx        | (pushed by second ir_stack_dup)
|                    |
| ------------------ |
|                    |
|         rbx        | (pushed by first ir_stack_dup)
|                    |
| ------------------ |
|                    |
|         rbx        | (pushed by ir_deref)
|                    |
| ------------------ |
</code></pre><p>Let&rsquo;s advance to the next instructions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov r10d,dword[rbx+8]
    imul r10d,dword[rbx+12]
    mov eax,r10d
    <span style="color:#75715e">;ir_mul [POP() . 1] [POP() . 2]; (push)</span>
</code></pre></div><p>Now there&rsquo;s two <em>POP()</em> operands, they are evaluated from right-to-left, but in this case it doesn&rsquo;t matter because multiplication is commutative and the operands are actually the same (the <em>rbx</em> register).</p>
<p>I&rsquo;m not going into to much detail, but the <code>[POP() . 1]</code> and <code>[POP() . 2]</code> expressions means a struct field access, which at this level is just applying some offset to a memory address, resulting in the <code>dword[rbx+8]</code> and <code>dword[rbx+12]</code> assembly expressions, respectively. So the struct field expressions will <em>POP</em> an operand from the stack (the <em>rbx</em> register) and apply the field offsets to the address contained in there. And since the <em>rbx</em> is duplicated in there, both expressions will use it. What that means, is that they are both accessing a different struct field from the same struct, in this case, the 1st argument for the <em>clear</em> function.</p>
<p>Just for reference, going back to the source code, these two assembly instructions represent the expression highlighted here:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*func clear(f: &amp;Field2D) {*/</span>
    <span style="color:#75715e">/*memset(f.data, 0, */</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">width</span><span style="color:#f92672">*</span><span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">height</span><span style="color:#75715e">/**sizeof(int))*/</span>
<span style="color:#75715e">/*}*/</span>
</code></pre></div><p>Okay, so the IR stack was popped two times, right? <code>;ir_mul [POP() . 1] [POP() . 2]; (push)</code> So how does it look now?</p>
<pre><code>| ------------------ |
|                    |
|         rbx        | 
|                    |
| ------------------ |
</code></pre><p>Only the good old original <em>rbx</em> register is alone in there without it&rsquo;s duplicated clones.</p>
<p>Let&rsquo;s look back for a moment at these instructions again:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov r10d,dword[rbx+8]
    imul r10d,dword[rbx+12]
    mov eax,r10d
    <span style="color:#75715e">;ir_mul [POP() . 1] [POP() . 2]; (push)</span>
</code></pre></div><p>At that last one <code>mov eax,r10d</code>, we are moving the result of the multiplication, which lives in the <em>r10d</em> register, into the <em>eax</em> register, which is actually the lower 32-bits of the <em>rax</em> register, meaning they are actually the same.</p>
<p>This actually means we are pushing the result of the multiplication back to the IR stack, let&rsquo;s visualize it:</p>
<pre><code>| ------------------ |
|                    |
|         eax        |
|                    |
| ------------------ |
|                    |
|         rbx        | 
|                    |
| ------------------ |
</code></pre><p>But now we are using the <em>rax</em>/<em>eax</em> register because the next instruction will pop it, let&rsquo;s check it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    imul eax,4
    <span style="color:#75715e">;ir_mul POP() 4; (push)</span>

    movsxd rax,eax
    <span style="color:#75715e">;ir_cast POP(); (push)</span>
</code></pre></div><p>We are popping from the stack, but also pushing to it again, and because the next instructions also pops <code>ir_cast POP()</code>, we can just work with the <em>eax</em> register, modifying it&rsquo;s value in-place, in this case, multiplying it by 4 (4 being the <code>sizeof(int)</code> from the source code).</p>
<p>The <code>movsxd rax,eax</code> is just sign-extending the 32-bit value in <em>eax</em> to itself, but in the 64-bit version, <em>rax</em>. So now the top of the stack actually contains the <em>rax</em>:</p>
<pre><code>| ------------------ |
|                    |
|         rax        |
|                    |
| ------------------ |
|                    |
|         rbx        | 
|                    |
| ------------------ |
</code></pre><p>Now let&rsquo;s see the last instruction of the function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov r8,rax
    xor dl,dl
    mov rcx,qword[rbx+0]
    call memset
    <span style="color:#75715e">;ir_call memset [POP() . 0] 0 POP();</span>
</code></pre></div><p>In this particular ABI (Windows x64 fastcall), we use the <em>rcx</em>, <em>rdx</em>/<em>dl</em>, <em>r8</em> and <em>r9</em> as arguments for making a function call. And since the instruction operands are evaluated right-to-left, each line of assembly above the <code>call</code> is representing a instruction operand.</p>
<p>So there&rsquo;s two <em>POP()</em> in there, and the first evaluated is the rightmost one. Remember what is at the top of the stack?</p>
<pre><code>| ------------------ |
|                    |
|         rax        | 
|                    |
| ------------------ |
|                    |
|         rbx        | 
|                    |
| ------------------ |
</code></pre><p>Okay, so we&rsquo;ll pop <em>rax</em> and use it as the third argument for the function call:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov r8,rax
</code></pre></div><p>And the stack now is:</p>
<pre><code>| ------------------ |
|                    |
|         rbx        | 
|                    |
| ------------------ |
</code></pre><p>For the second argument we&rsquo;re just putting 0 in the register using the xor instruction:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    xor dl,dl
</code></pre></div><p>And the first argument <code>[POP() . 0]</code> is a struct field access that uses a value from the stack to get the struct pointer, which translates to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    mov rcx,qword[rbx+0]
</code></pre></div><p>So we popped the last <em>rbx</em> from the stack, which is now empty. And we have finished the function, great!</p>
<p>Oh, there&rsquo;s also the function <em>epilogue</em>, which is just reversing everything that was done in the <em>prologue</em>, but that is for another time!</p>
<h2 id="outro">Outro</h2>
<p>Well, all this was just to share some thoughts about how a noob in compiler-crafting solved register allocation.</p>
<p>I&rsquo;m working slowly at this compiler and hope to at least have something that someone can make a snake game in it or something, the important part is that I&rsquo;m having fun while doing it. Thank you for reading!</p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        3100 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2022-04-28 00:30
        

         
          
        
      </p>
    </div>

    


    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2022</span>
            
            <span><a href="https://glhrmfrts.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Theme 'hello-friend-ng' by Djordje Atlialp</span>
          </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.af435e44374f1e99a669ea8cd5bb9a2fceed80588941a451bfddb66b86a67c9f40b0f417e9543a763f809aa7e9300d7b1d69bf99615810ba02ac70396d50fad5.js" integrity="sha512-r0NeRDdPHpmmaeqM1buaL87tgFiJQaRRv922a4amfJ9AsPQX6VQ6dj&#43;AmqfpMA17HWm/mWFYELoCrHA5bVD61Q=="></script>



    </body>
</html>
